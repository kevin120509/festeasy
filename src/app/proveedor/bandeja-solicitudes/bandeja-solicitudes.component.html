<!-- Contenido Principal -->
<div class="min-h-screen bg-slate-50">
    <!-- Notificaciones Toast -->
    @if (mensajeExito()) {
    <div
        class="fixed top-20 right-6 z-50 bg-green-500 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in">
        <span class="material-icons-outlined text-[24px]">check_circle</span>
        <span class="font-semibold">{{ mensajeExito() }}</span>
    </div>
    }

    @if (mensajeError()) {
    <div
        class="fixed top-20 right-6 z-50 bg-red-500 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in">
        <span class="material-icons-outlined text-[24px]">error</span>
        <span class="font-semibold">{{ mensajeError() }}</span>
    </div>
    }

    <style>
        @keyframes slide-in {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slide-in 0.3s ease;
        }

        .btn-success-gradient {
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
        }
    </style>

    <main class="max-w-7xl mx-auto p-8">
        <!-- Tabs de Navegación -->
        <div class="mb-8 overflow-x-auto">
            <div class="flex items-center gap-3 p-1.5 bg-slate-100 rounded-full w-fit">
                <!-- Tab Pendientes -->
                <button (click)="cambiarTab('pendientes')"
                    [class]="tabActivo() === 'pendientes' ? 'bg-white text-primary shadow-sm' : 'text-slate-500 hover:text-primary'"
                    class="flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm transition-all">
                    <span>Pendientes</span>
                    @if (contadores().pendientes > 0) {
                    <span
                        class="flex items-center justify-center bg-red-500 text-white text-[10px] w-5 h-5 rounded-full font-bold">
                        {{ contadores().pendientes }}
                    </span>
                    }
                </button>
                <!-- Tab Aceptadas -->
                <button (click)="cambiarTab('aceptadas')"
                    [class]="tabActivo() === 'aceptadas' ? 'bg-white text-primary shadow-sm' : 'text-slate-500 hover:text-primary'"
                    class="flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm transition-all">
                    <span>Aceptadas</span>
                    @if (contadores().aceptadas > 0) {
                    <span
                        class="flex items-center justify-center bg-green-500 text-white text-[10px] w-5 h-5 rounded-full font-bold">
                        {{ contadores().aceptadas }}
                    </span>
                    }
                </button>
                <!-- Tab Historial -->
                <button (click)="cambiarTab('historial')"
                    [class]="tabActivo() === 'historial' ? 'bg-white text-primary shadow-sm' : 'text-slate-500 hover:text-primary'"
                    class="flex items-center px-6 py-2.5 rounded-full font-bold text-sm transition-all">
                    Historial
                </button>
            </div>
        </div>

        <!-- Loading State -->
        @if (isLoading()) {
        <div class="flex flex-col gap-6">
            @for (i of [1, 2, 3]; track i) {
            <div class="bg-white rounded-xl p-8 animate-pulse">
                <div class="flex gap-6">
                    <div class="w-20 h-20 bg-slate-200 rounded-2xl"></div>
                    <div class="flex-1 space-y-4">
                        <div class="h-6 bg-slate-200 rounded w-1/3"></div>
                        <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-200 rounded w-1/4"></div>
                    </div>
                </div>
            </div>
            }
        </div>
        } @else {

        <!-- Lista de Solicitudes -->
        <div class="flex flex-col gap-8">
            @for (solicitud of solicitudesFiltradas(); track solicitud.id) {
            <div
                class="group relative bg-white rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-primary/5 overflow-hidden transition-all hover:shadow-[0_20px_40px_rgba(0,0,0,0.08)]">

                <!-- Banner de Urgencia (solo para pendientes) -->
                @if (solicitud.estado === 'pendiente_aprobacion') {
                <div [class]="solicitud.es_critico ? 'bg-red-500' : 'bg-amber-500'"
                    class="px-6 py-2.5 flex items-center gap-2 text-white text-sm font-bold uppercase tracking-wider">
                    <span class="material-symbols-outlined text-lg">schedule</span>
                    @if (solicitud.es_critico) {
                    <span>CRÍTICO: Quedan {{ formatearTiempoRestante(solicitud.horas_restantes) }} para responder</span>
                    } @else {
                    <span>Quedan {{ formatearTiempoRestante(solicitud.horas_restantes) }} para responder</span>
                    }
                </div>
                }

                <!-- Contenido de la Tarjeta -->
                <div class="p-8 flex flex-col md:flex-row gap-8">
                    <!-- Columna Izquierda: Perfil y Contexto -->
                    <div class="flex-1 flex gap-6">
                        <!-- Avatar del Cliente -->
                        <div
                            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-primary to-teal-500 flex items-center justify-center text-white text-2xl font-black border-4 border-slate-50 shrink-0 overflow-hidden">
                            @if (solicitud.cliente_avatar) {
                            <img [src]="solicitud.cliente_avatar" alt="Cliente" class="w-full h-full object-cover" />
                            } @else {
                            {{ solicitud.cliente_nombre.charAt(0) }}
                            }
                        </div>

                        <div class="flex flex-col gap-2">
                            <!-- Nombre y Badge de Tipo -->
                            <div class="flex items-center gap-3 flex-wrap">
                                <h3 class="text-slate-800 text-2xl font-black">{{ solicitud.cliente_nombre }}</h3>
                                <span
                                    class="px-3 py-1 bg-primary/10 text-primary text-xs font-bold rounded-full uppercase tracking-tight">
                                    {{ solicitud.tipo_evento }}
                                </span>
                            </div>

                            <!-- Fecha y Ubicación -->
                            <div class="flex flex-col gap-1 text-slate-500">
                                <div class="flex items-center gap-1.5 font-semibold text-sm">
                                    <span class="material-symbols-outlined text-base">calendar_today</span>
                                    <span>{{ formatearFecha(solicitud.fecha_servicio) }}</span>
                                </div>
                                <div class="flex items-center gap-1.5 font-semibold text-sm text-primary">
                                    <span class="material-symbols-outlined text-base">location_on</span>
                                    <span>{{ solicitud.direccion_servicio }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Servicio y Precio -->
                    <div
                        class="flex-1 flex flex-col items-start md:items-end justify-between text-left md:text-right gap-4">
                        <div>
                            <p class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-1">Servicio
                                Solicitado</p>
                            <p class="text-slate-800 text-lg font-bold">{{ solicitud.titulo_evento }}</p>
                        </div>
                        <div class="bg-slate-50 px-6 py-4 rounded-xl border border-primary/5">
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Precio Total</p>
                            <p class="text-primary text-3xl font-black">{{ solicitud.monto_total |
                                currency:'MXN':'symbol-narrow':'1.0-0' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Footer con Acciones -->
                @if (solicitud.estado === 'pendiente_aprobacion') {
                <div class="flex border-t border-primary/5">
                    <!-- Botón Rechazar -->
                    <button (click)="rechazarSolicitud(solicitud)" [disabled]="procesando() === solicitud.id"
                        class="flex-1 py-5 bg-slate-50 hover:bg-slate-100 text-slate-500 font-bold text-sm flex items-center justify-center gap-2 transition-colors disabled:opacity-50">
                        @if (procesando() === solicitud.id) {
                        <div class="animate-spin rounded-full h-5 w-5 border-2 border-slate-400 border-t-transparent">
                        </div>
                        } @else {
                        <span class="material-symbols-outlined text-lg">close</span>
                        <span>Rechazar Solicitud</span>
                        }
                    </button>
                    <!-- Botón Aceptar -->
                    <button (click)="aceptarSolicitud(solicitud)" [disabled]="procesando() === solicitud.id"
                        class="flex-1 py-5 btn-success-gradient text-white font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90 transition-opacity disabled:opacity-50">
                        @if (procesando() === solicitud.id) {
                        <div class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                        } @else {
                        <span class="material-symbols-outlined text-lg">check_circle</span>
                        <span>Aceptar y Agendar</span>
                        }
                    </button>
                </div>
                }

                <!-- Footer para Aceptadas -->
                @if (solicitud.estado === 'esperando_anticipo' || solicitud.estado === 'reservado' || solicitud.estado
                === 'en_progreso' || solicitud.estado === 'entregado_pendiente_liq') {
                <div class="flex flex-col border-t border-primary/5">
                    <div class="flex">

                        <button [routerLink]="['/proveedor/solicitudes', solicitud.id]"
                            class="flex-1 py-5 bg-slate-50 hover:bg-slate-100 text-primary font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                            <span class="material-symbols-outlined text-lg">visibility</span>
                            <span>Ver Detalles</span>
                        </button>
                    </div>

                    <!-- Botón de Seguridad (PIN) -->
                    @if (solicitud.estado === 'reservado') {
                    <div class="p-4 bg-slate-50 border-t border-primary/5">
                        <button (click)="esDiaDelEvento(solicitud.fecha_servicio) ? abrirModalPin(solicitud.id) : null"
                            [disabled]="!esDiaDelEvento(solicitud.fecha_servicio)" [class]="esDiaDelEvento(solicitud.fecha_servicio) 
                                ? 'bg-red-600 hover:bg-red-700 shadow-md' 
                                : 'bg-slate-300 cursor-not-allowed opacity-60'"
                            class="w-full py-4 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all">
                            <span class="material-symbols-outlined">key</span>
                            <span>Validar PIN para finalizar servicio</span>
                            @if (!esDiaDelEvento(solicitud.fecha_servicio)) {
                            <span class="text-[10px] bg-black/10 px-2 py-0.5 rounded-full ml-2">Bloqueado</span>
                            }
                        </button>

                        @if (!esDiaDelEvento(solicitud.fecha_servicio)) {
                        <p class="text-center text-[10px] text-slate-400 mt-2 font-medium">
                            Se habilitará el {{ formatearFechaCompleta(solicitud.fecha_servicio) }}
                        </p>
                        }
                    </div>
                    }
                </div>
                }

                <!-- Footer para Historial (Rechazadas, Finalizadas, etc) -->
                @if (['rechazada', 'finalizado', 'cancelada', 'abandonada'].includes(solicitud.estado)) {
                <div class="flex border-t border-primary/5">
                    <div class="flex-1 px-8 py-4 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" [class]="{
                            'bg-red-500': solicitud.estado === 'rechazada' || solicitud.estado === 'cancelada',
                            'bg-slate-400': solicitud.estado === 'finalizado'
                        }"></span>
                        <span class="text-xs font-bold text-slate-400 uppercase leading-none">{{ solicitud.estado
                            }}</span>
                    </div>
                    <button (click)="eliminarDelHistorial(solicitud)"
                        class="px-8 py-5 bg-red-50 hover:bg-red-100 text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                        <span class="material-symbols-outlined text-lg text-red-500">delete</span>
                        <span>Quitar del Historial</span>
                    </button>
                </div>
                }
            </div>

            } @empty {
            <!-- Estado Vacío -->
            <div
                class="bg-white rounded-xl py-20 text-center border-2 border-dashed border-slate-200 flex flex-col items-center justify-center gap-4">
                @if (tabActivo() === 'pendientes') {
                <span class="material-symbols-outlined text-slate-300 text-[64px]">inbox</span>
                <p class="text-slate-500 font-medium text-lg">No hay solicitudes pendientes</p>
                <p class="text-slate-400 text-sm">Las nuevas solicitudes de clientes aparecerán aquí</p>
                }
                @if (tabActivo() === 'aceptadas') {
                <span class="material-symbols-outlined text-slate-300 text-[64px]">event_available</span>
                <p class="text-slate-500 font-medium text-lg">No hay solicitudes aceptadas</p>
                <p class="text-slate-400 text-sm">Las solicitudes que aceptes aparecerán aquí</p>
                }
                @if (tabActivo() === 'historial') {
                <span class="material-symbols-outlined text-slate-300 text-[64px]">history</span>
                <p class="text-slate-500 font-medium text-lg">No hay historial disponible</p>
                <p class="text-slate-400 text-sm">Las solicitudes finalizadas o canceladas aparecerán aquí</p>
                }
            </div>
            }
        </div>
        }
    </main>

    <!-- Componente de Validación de PIN -->
    @if (mostrarModalPin()) {
    <app-validar-pin [isOpen]="mostrarModalPin()" [solicitudId]="solicitudSeleccionada()"
        (closeModal)="cerrarModalPin()" (pinValidado)="onPinValidado($any($event))">
    </app-validar-pin>
    }

    <!-- Diálogo de Confirmación Global -->
    <p-confirmDialog [style]="{width: '50vw'}" [baseZIndex]="10000"></p-confirmDialog>
</div>